# Phase 2: Sky-Shot Implementation Plan ğŸŒŒ

## Document Info
- **Version**: v4.0 Cosmic Context
- **Phase**: 2 of 4
- **Status**: Planning
- **Created**: 2026-01-02
- **Estimated Effort**: ~6-8 hours

---

## ğŸ¯ Objective

Render a **visual representation of the night sky** at the user's exact birth time and location, showing:
- The Moon's position in its correct Nakshatra
- The 27 Nakshatra boundaries along the ecliptic
- Educational overlays explaining the celestial positions

This transforms the Panchanga calculator from a "data display" into a "cosmic storyteller."

---

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER REQUEST                             â”‚
â”‚              (Date, Time, Location from form)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GET /api/skyshot                              â”‚
â”‚                                                                  â”‚
â”‚  1. Check cache (hash of date+time+lat+lon)                     â”‚
â”‚  2. If cached â†’ return existing image URL                        â”‚
â”‚  3. If not cached â†’ generate new sky map                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              utils/skyshot.py (NEW FILE)                         â”‚
â”‚                                                                  â”‚
â”‚  â€¢ get_nakshatra_boundaries() - 27 segment definitions          â”‚
â”‚  â€¢ get_moon_position() - Moon's sidereal longitude              â”‚
â”‚  â€¢ generate_skymap() - Matplotlib polar/circular plot           â”‚
â”‚  â€¢ save_to_cache() - Save PNG to static/skyshots/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              static/skyshots/<hash>.png                          â”‚
â”‚                                                                  â”‚
â”‚  Served via Flask/Nginx for display in UI                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `utils/skyshot.py` | **CREATE** | Core sky map generation logic |
| `app.py` | **MODIFY** | Add `/api/skyshot` endpoint |
| `templates/index.html` | **MODIFY** | Add sky map display section |
| `static/js/main.js` | **MODIFY** | Fetch and display sky map |
| `static/css/style.css` | **MODIFY** | Style the sky map section |
| `static/skyshots/` | **CREATE** | Directory for cached images |
| `requirements.txt` | **MODIFY** | Ensure matplotlib is present |

---

## ğŸ”§ Detailed Implementation

### 1ï¸âƒ£ utils/skyshot.py - Sky Map Generator

```python
"""
Sky-Shot Generator for Hindu Panchanga v4.0
Generates visual 2D sky maps showing Nakshatra positions.
"""

import matplotlib
matplotlib.use('Agg')  # Non-interactive backend for server
import matplotlib.pyplot as plt
import numpy as np
import hashlib
import os
from pathlib import Path

# 27 Nakshatras with their sidereal longitude ranges
NAKSHATRAS = [
    {"name": "Ashwini", "start": 0, "end": 13.333, "star": "Î² Ari"},
    {"name": "Bharani", "start": 13.333, "end": 26.667, "star": "41 Ari"},
    {"name": "Krittika", "start": 26.667, "end": 40, "star": "Alcyone"},
    {"name": "Rohini", "start": 40, "end": 53.333, "star": "Aldebaran"},
    {"name": "Mrigashira", "start": 53.333, "end": 66.667, "star": "Î» Ori"},
    {"name": "Ardra", "start": 66.667, "end": 80, "star": "Betelgeuse"},
    {"name": "Punarvasu", "start": 80, "end": 93.333, "star": "Pollux"},
    {"name": "Pushya", "start": 93.333, "end": 106.667, "star": "Î´ Cnc"},
    {"name": "Ashlesha", "start": 106.667, "end": 120, "star": "Îµ Hya"},
    {"name": "Magha", "start": 120, "end": 133.333, "star": "Regulus"},
    {"name": "Purva Phalguni", "start": 133.333, "end": 146.667, "star": "Î´ Leo"},
    {"name": "Uttara Phalguni", "start": 146.667, "end": 160, "star": "Î² Leo"},
    {"name": "Hasta", "start": 160, "end": 173.333, "star": "Î´ Crv"},
    {"name": "Chitra", "start": 173.333, "end": 186.667, "star": "Spica"},
    {"name": "Swati", "start": 186.667, "end": 200, "star": "Arcturus"},
    {"name": "Vishakha", "start": 200, "end": 213.333, "star": "Î± Lib"},
    {"name": "Anuradha", "start": 213.333, "end": 226.667, "star": "Î´ Sco"},
    {"name": "Jyeshtha", "start": 226.667, "end": 240, "star": "Antares"},
    {"name": "Mula", "start": 240, "end": 253.333, "star": "Î» Sco"},
    {"name": "Purva Ashadha", "start": 253.333, "end": 266.667, "star": "Î´ Sgr"},
    {"name": "Uttara Ashadha", "start": 266.667, "end": 280, "star": "Ïƒ Sgr"},
    {"name": "Shravana", "start": 280, "end": 293.333, "star": "Altair"},
    {"name": "Dhanishta", "start": 293.333, "end": 306.667, "star": "Î² Del"},
    {"name": "Shatabhisha", "start": 306.667, "end": 320, "star": "Î» Aqr"},
    {"name": "Purva Bhadrapada", "start": 320, "end": 333.333, "star": "Î± Peg"},
    {"name": "Uttara Bhadrapada", "start": 333.333, "end": 346.667, "star": "Î³ Peg"},
    {"name": "Revati", "start": 346.667, "end": 360, "star": "Î¶ Psc"},
]

# Color palette for Nakshatras (alternating for visibility)
NAKSHATRA_COLORS = [
    '#1a1a2e', '#16213e', '#0f3460', '#1a1a2e', '#16213e', '#0f3460',
    '#1a1a2e', '#16213e', '#0f3460', '#1a1a2e', '#16213e', '#0f3460',
    '#1a1a2e', '#16213e', '#0f3460', '#1a1a2e', '#16213e', '#0f3460',
    '#1a1a2e', '#16213e', '#0f3460', '#1a1a2e', '#16213e', '#0f3460',
    '#1a1a2e', '#16213e', '#0f3460'
]

CACHE_DIR = Path("static/skyshots")


def get_cache_key(date_str: str, time_str: str, lat: float, lon: float) -> str:
    """Generate unique hash for caching sky map images."""
    data = f"{date_str}-{time_str}-{lat:.2f}-{lon:.2f}"
    return hashlib.md5(data.encode()).hexdigest()[:12]


def get_cached_image(cache_key: str) -> str | None:
    """Check if cached image exists, return path if found."""
    image_path = CACHE_DIR / f"{cache_key}.png"
    if image_path.exists():
        return str(image_path)
    return None


def get_nakshatra_index(moon_longitude: float) -> int:
    """Get the Nakshatra index (0-26) for given sidereal longitude."""
    return int(moon_longitude / 13.333333) % 27


def generate_skymap(
    moon_longitude: float,
    nakshatra_name: str,
    nakshatra_pada: int,
    phase_angle: float,
    output_path: str
) -> str:
    """
    Generate an ecliptic wheel sky map showing the Moon's position.
    
    Args:
        moon_longitude: Moon's sidereal longitude (0-360Â°)
        nakshatra_name: Name of the current Nakshatra
        nakshatra_pada: Pada number (1-4)
        phase_angle: Sun-Moon angular separation (for moon phase)
        output_path: Path to save the generated PNG
    
    Returns:
        Path to the generated image
    """
    # Create figure with dark background
    fig, ax = plt.subplots(figsize=(10, 10), subplot_kw=dict(polar=True))
    fig.patch.set_facecolor('#0a0a0f')
    ax.set_facecolor('#0a0a0f')
    
    # Draw 27 Nakshatra segments
    for i, nak in enumerate(NAKSHATRAS):
        start_rad = np.radians(nak["start"])
        end_rad = np.radians(nak["end"])
        
        # Highlight current Nakshatra
        if nak["name"] == nakshatra_name:
            color = '#e94560'  # Bright highlight
            alpha = 0.8
        else:
            color = NAKSHATRA_COLORS[i]
            alpha = 0.5
        
        # Draw segment arc
        theta = np.linspace(start_rad, end_rad, 50)
        r_inner = 0.6
        r_outer = 1.0
        
        ax.fill_between(theta, r_inner, r_outer, color=color, alpha=alpha)
        
        # Add Nakshatra name label
        mid_angle = (start_rad + end_rad) / 2
        label_r = 0.8
        ax.text(
            mid_angle, label_r, nak["name"][:4],
            ha='center', va='center',
            fontsize=7, color='#ffffff',
            rotation=np.degrees(mid_angle) - 90,
            rotation_mode='anchor'
        )
    
    # Draw Moon position
    moon_rad = np.radians(moon_longitude)
    moon_r = 0.8
    
    # Moon symbol based on phase
    if phase_angle < 10 or phase_angle > 350:
        moon_symbol = 'ğŸŒ‘'  # New Moon
    elif 170 < phase_angle < 190:
        moon_symbol = 'ğŸŒ•'  # Full Moon
    elif phase_angle < 180:
        moon_symbol = 'ğŸŒ“'  # First Quarter
    else:
        moon_symbol = 'ğŸŒ—'  # Last Quarter
    
    ax.plot(moon_rad, moon_r, 'o', markersize=20, color='#ffd700', 
            markeredgecolor='#ffffff', markeredgewidth=2)
    ax.annotate(moon_symbol, (moon_rad, moon_r), fontsize=24, ha='center', va='center')
    
    # Draw Earth at center
    ax.plot(0, 0, 'o', markersize=15, color='#4a90d9', 
            markeredgecolor='#ffffff', markeredgewidth=1)
    ax.text(0, 0, 'ğŸŒ', fontsize=16, ha='center', va='center')
    
    # Title and caption
    fig.suptitle(
        f"ğŸŒŒ Moon in {nakshatra_name} (Pada {nakshatra_pada})",
        fontsize=16, color='#ffffff', fontweight='bold', y=0.95
    )
    
    ax.text(
        0, -1.3, f"Moon Position: {moon_longitude:.1f}Â° Sidereal",
        transform=ax.transAxes, ha='center', va='center',
        fontsize=10, color='#888888'
    )
    
    # Configure polar plot
    ax.set_theta_zero_location('N')  # 0Â° at top
    ax.set_theta_direction(-1)  # Clockwise
    ax.set_ylim(0, 1.1)
    ax.set_xticks([])
    ax.set_yticks([])
    ax.spines['polar'].set_visible(False)
    
    # Save figure
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    plt.savefig(output_path, dpi=150, bbox_inches='tight', 
                facecolor=fig.get_facecolor(), edgecolor='none')
    plt.close(fig)
    
    return output_path
```

---

### 2ï¸âƒ£ API Endpoint (app.py)

```python
from utils.skyshot import generate_skymap, get_cache_key, get_cached_image, CACHE_DIR

@app.route('/api/skyshot', methods=['POST'])
def get_skyshot():
    """Generate or retrieve cached sky map image."""
    data = request.json
    date_str = data.get('date')
    time_str = data.get('time')
    location_name = data.get('location')
    
    if not all([date_str, time_str, location_name]):
        return jsonify({"success": False, "error": "Missing required fields"}), 400
    
    try:
        # 1. Resolve location
        loc = get_location_details(location_name)
        
        # 2. Check cache
        cache_key = get_cache_key(date_str, time_str, loc["latitude"], loc["longitude"])
        cached = get_cached_image(cache_key)
        
        if cached:
            return jsonify({
                "success": True,
                "image_url": f"/{cached}",
                "cached": True
            })
        
        # 3. Calculate astronomical data
        dt_str = f"{date_str} {time_str}"
        naive_dt = datetime.strptime(dt_str, "%Y-%m-%d %H:%M")
        local_tz = pytz.timezone(loc["timezone"])
        local_dt = local_tz.localize(naive_dt)
        utc_dt = local_dt.astimezone(pytz.utc)
        
        moon_lon = get_sidereal_longitude(utc_dt, moon)
        angular_data = get_angular_data(local_dt, loc["latitude"], loc["longitude"], loc["timezone"])
        
        # Get Nakshatra info
        nakshatra, nak_pada = calculate_nakshatra(moon_lon, lang='EN')
        
        # 4. Generate sky map
        output_path = str(CACHE_DIR / f"{cache_key}.png")
        generate_skymap(
            moon_longitude=moon_lon,
            nakshatra_name=nakshatra,
            nakshatra_pada=nak_pada,
            phase_angle=angular_data["phase_angle"],
            output_path=output_path
        )
        
        return jsonify({
            "success": True,
            "image_url": f"/{output_path}",
            "cached": False
        })
        
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500
```

---

### 3ï¸âƒ£ Frontend Integration

#### HTML (templates/index.html)
```html
<!-- Add after fact-cards section -->
<section id="skyshot-section" class="card glass hidden">
    <h3>ğŸŒŒ Your Sky at Birth</h3>
    <div id="skyshot-container">
        <img id="skyshot-image" src="" alt="Sky Map showing Moon position">
    </div>
    <p id="skyshot-caption" class="caption">
        This ecliptic wheel shows where the Moon was positioned among the 27 Nakshatras.
    </p>
</section>
```

#### JavaScript (static/js/main.js)
```javascript
// Add after renderResult function displays results
async function loadSkyshot(data) {
    const skyshotSection = document.getElementById('skyshot-section');
    const skyshotImage = document.getElementById('skyshot-image');
    
    try {
        const response = await fetch('/api/skyshot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            skyshotImage.src = result.image_url;
            skyshotSection.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Skyshot error:', error);
    }
}
```

#### CSS (static/css/style.css)
```css
/* Sky-Shot Section */
#skyshot-section {
    text-align: center;
    padding: 2rem;
}

#skyshot-container {
    max-width: 500px;
    margin: 1rem auto;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(233, 69, 96, 0.3);
}

#skyshot-image {
    width: 100%;
    height: auto;
    display: block;
}

#skyshot-caption {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 1rem;
}
```

---

## ğŸ¨ Visual Design Specification

### Ecliptic Wheel Design

```
                    N (0Â°)
                      â”‚
         Revati       â”‚       Ashwini
                      â”‚
    Uttara B. â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€ Bharani
                      â”‚
         Purva B.     â”‚       Krittika
                      â”‚
    W (270Â°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€ E (90Â°)
                 ğŸŒ Earth
         Shatab.      â”‚       Rohini
                      â”‚
    Dhanishta â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€ Mrigashira
                      â”‚
         Shravana     â”‚       Ardra
                      â”‚
                    S (180Â°)

Legend:
  â— = Earth (center)
  ğŸŒ™ = Moon position (on the wheel)
  ğŸ”´ = Highlighted current Nakshatra
```

### Color Scheme

| Element | Color | Hex Code |
|---------|-------|----------|
| Background | Deep Space | `#0a0a0f` |
| Nakshatra Segments | Navy shades | `#1a1a2e`, `#16213e`, `#0f3460` |
| Current Nakshatra | Ruby Red | `#e94560` |
| Moon Marker | Gold | `#ffd700` |
| Earth | Ocean Blue | `#4a90d9` |
| Text | White | `#ffffff` |
| Caption | Muted Gray | `#888888` |

---

## ğŸ“¦ Dependencies

```txt
# requirements.txt additions
matplotlib>=3.7.0
```

---

## ğŸ—‚ï¸ Directory Structure (After Implementation)

```
gregorian_to_hindu_calendar/
â”œâ”€â”€ app.py                          # Modified: +/api/skyshot
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ astronomy.py                # Existing
â”‚   â”œâ”€â”€ skyshot.py                  # NEW: Sky map generator
â”‚   â””â”€â”€ ...
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/style.css               # Modified: +skyshot styles
â”‚   â”œâ”€â”€ js/main.js                  # Modified: +loadSkyshot()
â”‚   â””â”€â”€ skyshots/                   # NEW: Cached images
â”‚       â”œâ”€â”€ a1b2c3d4e5f6.png
â”‚       â””â”€â”€ ...
â””â”€â”€ templates/
    â””â”€â”€ index.html                  # Modified: +skyshot section
```

---

## â±ï¸ Task Breakdown

| # | Task | Estimate | Dependencies |
|---|------|----------|--------------|
| 1 | Create `utils/skyshot.py` with NAKSHATRAS data | 1 hour | None |
| 2 | Implement `generate_skymap()` with Matplotlib | 2 hours | Task 1 |
| 3 | Add caching utilities | 30 min | Task 2 |
| 4 | Add `/api/skyshot` endpoint to `app.py` | 30 min | Task 3 |
| 5 | Update `index.html` with skyshot section | 30 min | None |
| 6 | Update `main.js` with `loadSkyshot()` | 30 min | Task 5 |
| 7 | Add CSS styling for skyshot | 30 min | Task 5 |
| 8 | Integration testing | 1 hour | All |
| 9 | Performance testing & optimization | 1 hour | Task 8 |
| **Total** | | **~7-8 hours** | |

---

## âœ… Acceptance Criteria

1. [ ] Sky map displays correctly after Panchanga calculation
2. [ ] Moon position accurately reflects sidereal longitude
3. [ ] Current Nakshatra is visually highlighted
4. [ ] Images are cached to avoid regeneration
5. [ ] Responsive design works on mobile
6. [ ] Generation time < 2 seconds for new images
7. [ ] Cached images load < 100ms

---

## ğŸ”® Future Enhancements (Phase 3+)

- **Interactive zoom** on Nakshatra segments
- **Star overlay** showing actual constellation stars
- **Solar System view** (top-down planetary positions)
- **Animation** showing Moon movement over time
- **Download option** for the sky map image

---

## ğŸ“ Notes

- Using Matplotlib with 'Agg' backend for server-side rendering
- Polar plot provides intuitive circular representation
- Caching prevents redundant computation for same date/location
- Design prioritizes education over astronomical accuracy
